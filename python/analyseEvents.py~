#!/usr/bin/python

import os
import MySQLdb as mdb
import datetime

try:
	con = mdb.connect('localhost', 'root', 'root', 'github')
	cur = con.cursor()	
	#Selecting top 100 users	
	cur.execute("SELECT followedUser_login from FollowEvents GROUP BY followedUser_login ORDER BY followedUser_followers DESC")
	rows = cur.fetchall()
	for row in rows:
	
		#Watch events by popular users
		sql = 'SELECT repo_url,timeStamp,repo_watchers,eventType,timeStamp,actor from AllEvents WHERE actor="'+row[0]+'" AND eventType IN ("PushEvent","WatchEvent")'
		cur.execute(sql)
		innerRows = cur.fetchall()	
		intialWatchCount=0
		finalWatchCount=0
		actor=""
		for iRow in innerRows:
			intialWatchCount = iRow[2]
			rawTime = iRow[4]
			actor = iRow[5];
			eventType = iRow[3]
			try:
				timeStamp1 = datetime.datetime.strptime(rawTime[:rawTime.rfind('-')],'%Y-%m-%dT%H:%M:%S')
			except Exception as e:
				timeStamp1 = datetime.datetime.strptime(rawTime[:rawTime.rfind(' ')],'%Y/%m/%d %H:%M:%S')
				pass
			sql = 'SELECT repo_watchers,timeStamp from AllEvents WHERE repo_url="'+iRow[0]+'" ORDER BY repo_watchers';
			cur.execute(sql)
			row2 = cur.fetchall()
			countArray = []
			count =0;	
			for irow in row2:
				rawTime = irow[1]
				try:
					timeStamp2 = datetime.datetime.strptime(rawTime[:rawTime.rfind('-')],'%Y-%m-%dT%H:%M:%S')
				except Exception as e:
					timeStamp2 = datetime.datetime.strptime(rawTime[:rawTime.rfind(' ')],'%Y/%m/%d %H:%M:%S')
					pass
				#Events after the popular user started watching, Time Delta = 5 mins
				if timeStamp2 > timeStamp1 and timeStamp2 < timeStamp1 + datetime.timedelta(minutes=60):
					count = count +1
				elif timeStamp2 > timeStamp1 and timeStamp2 > timeStamp1 + datetime.timedelta(minutes=60):
					growth = irow[0]-intialWatchCount
					sql = 'INSERT INTO repoGrowthAll VALUES('+'"'+mdb.escape_string(iRow[0])+'","'+actor+'",'+str(intialWatchCount)+','+str(irow[0])+','
						+str(growth)+',"'+eventType+'"'+',"'+str(timeStamp1)+'"'+',"'+str(timeStamp2)+'")'
					print sql
					cur.execute(sql)
					con.commit()
					break	
				
		
except Exception as e:
	print e
	pass
		
finally:
	
	if con:
		con.close()
